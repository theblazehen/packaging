# Packaging Workspace

This workspace manages packaging for various distribution channels.

## Structure
- `aur/`: Arch User Repository packages
- `docker/aur-builder/`: Container image with OpenCode + Arch build tools
- `nvchecker.toml`: Version checking configuration
- `.github/workflows/`: Automated update workflows

## Adding a New AUR Package

1. **Add to nvchecker.toml**:
   ```toml
   # For npm packages:
   [my-package]
   source = "npm"
   npm = "my-package"
   
   # For GitHub releases:
   [my-package]
   source = "github"
   github = "owner/repo"
   use_latest_release = true
   prefix = "v"  # if tags are like v1.2.3
   
   # For -git packages (track HEAD):
   [my-package-git]
   source = "git"
   git = "https://github.com/owner/repo.git"
   use_commit = true
   ```

2. **Add initial version to `.github/nvchecker/old_ver.json`**:
   ```json
   {
     "my-package": "1.0.0"
   }
   ```
   For -git packages, use the short commit hash (7 chars).

3. **Create package directory**:
   ```
   aur/my-package/
   ├── PKGBUILD
   ├── AGENTS.md      # Package-specific build/test instructions
   └── .SRCINFO       # Generated by makepkg --printsrcinfo
   ```

4. **Push to main** - automation will handle the rest.

## Automation (GitHub Actions + OpenCode)

Daily automated workflow:
1. **nvchecker** detects upstream version changes
2. **OpenCode** (claude-opus-4-5) prepares updates in Arch container:
   - Updates PKGBUILD
   - Runs `updpkgsums`
   - Builds with `makepkg -sf` and observes output
   - Smoke tests the install
   - Generates `.SRCINFO`
3. Creates **PR with changelog** for human review (or Issue if build fails)
4. On PR merge, **auto-pushes to AUR**

### Secrets Required
- `LLM_PROXY_API_KEY`: OpenCode LLM access
- `AUR_SSH_PRIVATE_KEY`: SSH key for AUR push

### Manual Trigger
Run workflow manually: Actions → "AUR Package Update Check" → Run workflow

## Tools
- `makepkg`: Build Arch packages
- `updpkgsums`: Update checksums in PKGBUILD
- `namcap`: Package quality control (install if missing)
- `nvchecker`: Upstream version detection

## Global Policies
- **License**: Ensure proper SPDX identifiers
- **Checksums**: NEVER use 'SKIP' for checksums. Always use proper sha256sums (run `updpkgsums`)
- **Security**: Don't embed secrets
- **Communication**: Use concise commit messages

## Current Packages (13 total)

| Package | Type | Source |
|---------|------|--------|
| promptfoo | npm | `promptfoo` |
| kimaki | npm | `kimaki` |
| claude-code-ui | npm | `@anthropic-ai/claude-code` |
| code-notify | GitHub | `mylee04/code-notify` |
| yacy | GitHub | `yacy/yacy_search_server` |
| ccstatusline | npm | `ccstatusline` |
| openchamber | GitHub | `nicobrenner/openchamber` |
| bdui-bin | GitHub | `AnubhabB/retaurant-llm` |
| xmenu | GitHub | `phillbush/xmenu` |
| arweave-deploy-bin | GitHub | `ArweaveTeam/arweave-deploy` |
| blender-mcp-git | git | `ahgsql/blender-mcp` |
| lazybeads-git | git | `theblazehen/lazybeads` |
| fractalart-git | git | `theblazehen/FractalArt` |

## Package Files

Each package directory contains:
- `PKGBUILD` - Package build script
- `.SRCINFO` - Generated metadata (run `makepkg --printsrcinfo > .SRCINFO`)
- `mise.toml` - Local tasks (build, test, lint)
- `AGENTS.md` - Package-specific instructions
- `.aur-files` - Manifest of files to push to AUR
- `.aur-remote` - AUR git remote URL

Some packages have additional files:
- `yacy`: `.install`, `.service`, `.sh` scripts
- `fractalart-git`: `.desktop`, `.install` files

## Workflow Details

### check-updates.yml

The main workflow that:
1. Runs nvchecker to detect version changes
2. Spawns OpenCode in an Arch container to update packages
3. Creates PRs for successful updates or Issues for failures

**Key features:**
- Runs as UID 1001 (`builder` user) for makepkg compatibility
- Per-package workspace caching
- 15-minute timeout for builds (`timeout: 900000`)
- Single build after version update (no redundant rebuilds)

### aur-push.yml

Triggered on PR merge to main:
1. Reads `.aur-files` manifest for each changed package
2. Pushes listed files to the AUR git remote

## Container Image

Built from `.github/builder/Dockerfile`:
- Base: `archlinux:base-devel`
- Tools: mise, jujutsu (jj), OpenCode, namcap
- User: `builder` (UID 1001) for makepkg

## Mise Tasks

Global tasks in `.mise/tasks/`:
- `setup-workspace` - Initialize jj colocated repo
- `sync-upstream` - Sync with AUR remote
- `export-patches` - Export local changes as patches
- `gather-context` - Collect context for OpenCode
- `aur-push` - Push to AUR (reads `.aur-files`)

Per-package tasks in `aur/*/mise.toml`:
- `build` - Build with makepkg
- `test` - Install and basic smoke test
- `lint` - Run namcap checks
