# Packaging Workspace

This workspace manages packaging for various distribution channels.

## Structure
- `aur/`: Arch User Repository packages
- `docker/aur-builder/`: Container image with OpenCode + Arch build tools
- `nvchecker.toml`: Version checking configuration
- `.github/workflows/`: Automated update workflows

## Adding a New AUR Package

1. **Add to nvchecker.toml**:
   ```toml
   # For npm packages:
   [my-package]
   source = "npm"
   npm = "my-package"
   
   # For GitHub releases:
   [my-package]
   source = "github"
   github = "owner/repo"
   use_latest_release = true
   prefix = "v"  # if tags are like v1.2.3
   
   # For -git packages (track HEAD):
   [my-package-git]
   source = "git"
   git = "https://github.com/owner/repo.git"
   use_commit = true
   ```

2. **Add initial version to `.github/nvchecker/old_ver.json`**:
   ```json
   {
     "my-package": "1.0.0"
   }
   ```
   For -git packages, use the short commit hash (7 chars).

3. **Create package directory**:
   ```
   aur/my-package/
   ├── PKGBUILD
   ├── AGENTS.md      # Package-specific build/test instructions
   └── .SRCINFO       # Generated by makepkg --printsrcinfo
   ```

4. **Push to main** - automation will handle the rest.

## Automation (GitHub Actions + OpenCode)

Daily automated workflow (script-first, LLM only when needed):

1. **nvchecker** detects upstream version changes
2. **Scripts** handle the happy path mechanically:
   - `fetch-changelog.sh` fetches real upstream changelog (GitHub releases, commit log)
   - `try-update.sh` bumps version, updates checksums, builds, runs namcap
   - `create-pr.sh` creates branch, commits, pushes, opens PR with auto-merge
3. **LLM** is invoked in two scenarios:
   - **Build succeeded**: Reviews build output + namcap + changelog for issues worth fixing
   - **Build failed**: Diagnoses failure, fixes PKGBUILD, rebuilds
4. On PR merge, **auto-pushes to AUR**

### Scripts (`.github/scripts/`)
- `try-update.sh` - Mechanical version bump + checksums + build + namcap + srcinfo + export
- `fetch-changelog.sh` - Fetches upstream changelog (GitHub releases, git compare, npm)
- `create-pr.sh` - Creates feature branch, commits, pushes, opens PR with auto-merge

### Secrets Required
- `LLM_PROXY_API_KEY`: OpenCode LLM access
- `AUR_SSH_PRIVATE_KEY`: SSH key for AUR push

### Manual Trigger
Run workflow manually: Actions → "AUR Package Update Check" → Run workflow

## Tools
- `makepkg`: Build Arch packages
- `updpkgsums`: Update checksums in PKGBUILD
- `namcap`: Package quality control (install if missing)
- `nvchecker`: Upstream version detection
- `yay`: AUR helper (installed in builder container, used by `try-update.sh` to install AUR-only deps)

## Global Policies
- **License**: Ensure proper SPDX identifiers
- **Checksums**: NEVER use 'SKIP' for checksums. Always use proper sha256sums (run `updpkgsums`)
- **Security**: Don't embed secrets
- **Communication**: Use concise commit messages

## Current Packages (17 total)

| Package | Type | Source |
|---------|------|--------|
| promptfoo | npm | `promptfoo` |
| kimaki | npm | `kimaki` |
| claude-code-ui | npm | `@anthropic-ai/claude-code` |
| code-notify | GitHub | `mylee04/code-notify` |
| yacy | GitHub | `yacy/yacy_search_server` |
| ccstatusline | npm | `ccstatusline` |
| python-smooth | PyPI | `smooth-py` |
| openchamber | GitHub | `nicobrenner/openchamber` |
| bdui-bin | GitHub | `AnubhabB/retaurant-llm` |
| xmenu | GitHub | `phillbush/xmenu` |
| arweave-deploy-bin | GitHub | `ArweaveTeam/arweave-deploy` |
| caire | GitHub | `esimov/caire` |
| yt-beats | GitHub | `krishnakanthb13/yt-beats` |
| blender-mcp-git | git | `ahgsql/blender-mcp` |
| lazybeads-git | git | `theblazehen/lazybeads` |
| fractalart-git | git | `theblazehen/FractalArt` |
| jdwp-mcp-git | git | `navicore/jdwp-mcp` |

## Package Files

Each package directory contains:
- `PKGBUILD` - Package build script
- `.SRCINFO` - Generated metadata (run `makepkg --printsrcinfo > .SRCINFO`)
- `mise.toml` - Local tasks (build, test, lint)
- `AGENTS.md` - Package-specific instructions
- `.aur-files` - Manifest of files to push to AUR
- `.aur-remote` - AUR git remote URL

Some packages have additional files:
- `yacy`: `.install`, `.service`, `.sh` scripts
- `fractalart-git`: `.desktop`, `.install` files

## Workflow Details

### check-updates.yml

The main workflow that:
1. Runs nvchecker to detect version changes
2. Fetches upstream changelog via `fetch-changelog.sh`
3. Attempts mechanical update via `try-update.sh` (version bump + build)
4. On build success: LLM reviews output for issues worth fixing
5. On build failure: LLM diagnoses and attempts fix
6. Creates PR via `create-pr.sh` with changelog + review in body
7. Waits for auto-merge, then pushes to AUR

**Key features:**
- Runs as UID 1001 (`builder` user) for makepkg compatibility
- Per-package workspace caching
- 30-minute timeout per package
- Script-first: LLM only invoked for review/failures (saves cost + avoids LLM flakiness)
- Sequential execution (`max-parallel: 1`) with `git fetch origin main` between jobs

## Container Image

Built from `.github/builder/Dockerfile`:
- Base: `archlinux:base-devel`
- Tools: mise, jujutsu (jj), OpenCode, namcap
- User: `builder` (UID 1001) for makepkg

## Mise Tasks

Global tasks in `.mise/tasks/`:
- `setup-workspace` - Initialize jj colocated repo
- `sync-upstream` - Sync with AUR remote
- `export-patches` - Export local changes as patches
- `gather-context` - Collect context for OpenCode
- `aur-push` - Push to AUR (reads `.aur-files`)

Per-package tasks in `aur/*/mise.toml`:
- `build` - Build with makepkg
- `test` - Install and basic smoke test
- `lint` - Run namcap checks
