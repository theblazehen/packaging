name: Push to AUR

on:
  push:
    branches: [main]
    paths:
      - 'aur/**/PKGBUILD'
      - 'aur/**/.SRCINFO'
  workflow_dispatch:
    inputs:
      packages:
        description: 'Space-separated list of packages to push (e.g., "ranger-git promptfoo")'
        required: true
        type: string

jobs:
  push-to-aur:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup SSH for AUR
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/aur
          chmod 600 ~/.ssh/aur
          ssh-keyscan aur.archlinux.org >> ~/.ssh/known_hosts
          
          cat >> ~/.ssh/config << 'EOF'
          Host aur.archlinux.org
            IdentityFile ~/.ssh/aur
            User aur
            IdentitiesOnly yes
          EOF

      - name: Determine changed packages
        id: changed
        run: |
          if [[ -n "${{ inputs.packages }}" ]]; then
            packages="${{ inputs.packages }}"
          else
            packages=$(git diff --name-only HEAD~1 HEAD \
              | grep '^aur/' \
              | cut -d/ -f2 \
              | sort -u \
              | tr '\n' ' ')
          fi
          echo "packages=$packages" >> $GITHUB_OUTPUT
          echo "Packages to push: $packages"

      - name: Push to AUR
        run: |
          for pkg in ${{ steps.changed.outputs.packages }}; do
            echo "═══════════════════════════════════════════════"
            echo "Pushing $pkg to AUR..."
            echo "═══════════════════════════════════════════════"
            
            cd aur/$pkg
            
            # Validate .aur-files exists
            if [[ ! -f .aur-files ]]; then
              echo "ERROR: .aur-files not found in aur/$pkg"
              exit 1
            fi
            
            git clone ssh://aur@aur.archlinux.org/$pkg.git ../aur-$pkg-temp 2>/dev/null || {
              echo "New package, initializing..."
              mkdir -p ../aur-$pkg-temp
              cd ../aur-$pkg-temp
              git init --initial-branch=master
              git remote add origin ssh://aur@aur.archlinux.org/$pkg.git
              cd -
            }
            
            # Copy files listed in .aur-files (fail if missing)
            while IFS= read -r file || [[ -n "$file" ]]; do
              # Skip empty lines and comments
              [[ -z "$file" || "$file" == \#* ]] && continue
              
              if [[ ! -e "$file" ]]; then
                echo "ERROR: File '$file' listed in .aur-files does not exist"
                exit 1
              fi
              
              cp -r "$file" ../aur-$pkg-temp/
              echo "Copied: $file"
            done < .aur-files
            
            cd ../aur-$pkg-temp
            
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            
            git add -A
            
            COMMIT_MSG=$(git -C "$GITHUB_WORKSPACE" log --format=%s -1)
            
            if ! git diff --staged --quiet; then
              git commit -m "$COMMIT_MSG"
              git push origin master
              echo "Successfully pushed $pkg to AUR"
            else
              echo "No changes to push for $pkg"
            fi
            
            cd "$GITHUB_WORKSPACE"
          done

      - name: Summary
        run: |
          echo "## AUR Push Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for pkg in ${{ steps.changed.outputs.packages }}; do
            echo "- [$pkg](https://aur.archlinux.org/packages/$pkg)" >> $GITHUB_STEP_SUMMARY
          done
